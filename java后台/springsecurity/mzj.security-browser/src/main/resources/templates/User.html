<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Test</title>
    <script type="text/javascript"
            th:src="@{/js/jquery-easyui-1.7.0/jquery.min.js}"
            src="/js/jquery-easyui-1.7.0/jquery.min.js"></script>
    <script type="text/javascript"
            th:src="@{/js/jquery.easyui.min.js}"
            src="/js/jquery.easyui.min.js"></script>
    <script type="text/javascript"
            th:src="@{/js/common.js}"
            src="/js/common.js"></script>
    <script type="text/javascript"
            th:src="@{/js/datagrid-filter.js}"
            src="/js/datagrid-filter.js"></script>
    <script type="text/javascript"
            th:src="@{/js/jquery-easyui-1.7.0/easyui-lang-zh_CN.js}"
            src="/js/jquery-easyui-1.7.0/easyui-lang-zh_CN.js"></script>
    <link rel="stylesheet" type="text/css"
          th:href="@{/css/easyui.css}"
          href="../../static/css/easyui.css"/>
    <link rel="stylesheet" type="text/css"
          th:href="@{/css/icon.css}"
          href="../../static/css/icon.css"/>

    <link href="/js/kindeditor-4.1.10/themes/default/default.css"
          th:href="@{/js/kindeditor-4.1.10/themes/default/default.css}"
          type="text/css" rel="stylesheet">
    <script type="text/javascript" charset="utf-8"
            th:src="@{/js/kindeditor-4.1.10/kindeditor-all-min.js}"
            src="/js/kindeditor-4.1.10/kindeditor-all-min.js"></script>
    <script type="text/javascript" charset="utf-8"
            th:src="@{/js/kindeditor-4.1.10/lang/zh_CN.js}"
            src="/js/kindeditor-4.1.10/lang/zh_CN.js"></script>

</head>

<body>
<table class="easyui-datagrid" id="userList" title="用户列表"
       data-options="singleSelect:false,collapsible:true,pagination:true,rownumbers:true
       ,url:'/user',
       	method:'get',pageSize:10,fitColumns:true,toolbar:toolbar_user">
    <thead>
    <tr>
        <th data-options="field:'ck',checkbox:true"></th>
        <th data-options="field:'userId',align:'center',width:100">用户ID</th>
        <th data-options="field:'userName',align:'center',width:100">登录名</th>
        <th data-options="field:'name',align:'center',width:100">用户名</th>
        <th data-options="field:'state',align:'center',width:100">状态</th>
        <th data-options="field:'permissionNames',align:'center',width:100,formatter:formatRoles">角色</th>
    </tr>
    </thead>
</table>

<div id="toolbar_user" style=" height: 22px; padding: 3px 11px; background: #fafafa;">

    <div style="float: left;">
        <a href="#" class="easyui-linkbutton" plain="true" icon="icon-add" onclick="user_add()">新增</a>
    </div>
    <div style="float: left;">
        <a href="#" class="easyui-linkbutton" plain="true" icon="icon-cancel" onclick="user_delete()">
            删除
        </a>
    </div>
    <div class="datagrid-btn-separator"></div>
    <div style="float: left;">
        <a href="#" class="easyui-linkbutton" plain="true" icon="icon-reload" onclick="user_reload()">刷新</a>
    </div>

</div>



<div id="userAddWindow" class="easyui-window" title="添加用户" data-options="modal:true,
	closed:true,resizable:true,iconCls:'icon-save',href:'/page/UserAdd'" style="width:40%;height:70%;padding:10px;">
</div>

<div id="rolesDialog" class="easyui-dialog" title="查看角色"
     data-options="modal:true,closed:true,resizable:true,
	iconCls:'icon-save'" style="width:800px;height:500px;">
    <div style="float: left;">
        选择角色：<input id="cc"/>
        <a href="#" class="easyui-linkbutton" plain="true" icon="icon-add" onclick="saverole()">添加角色</a>
        <a href="#" class="easyui-linkbutton" plain="true"
           icon="icon-cancel" onclick="delRole()">
            删除
        </a>
    </div>
    <div>
        <table id="dg"
               class="easyui-datagrid" title="角色列表"
               data-options="singleSelect:false,collapsible:true
           ,pagination:true,rownumbers:true" style="width:600px;height:500px;"></table>
    </div>
</div>


<script type="text/javascript" th:inline="none">
    function onRolesClickRow(index) {
        var rows = $('#dg').datagrid('getRows');
        return rows[index];
    }

    function getUserRolesSelectionsIds() {
        var userRolesList = $("#dg");
        var sels = userRolesList.datagrid("getSelections");
        var ids = [];
        for (var i in sels) {
            ids.push(sels[i].roleId);
        }
        ids = ids.join(",");
        return ids;
    }

    function delRole() {
        var ids = getUserRolesSelectionsIds();
        console.log(ids);
        if (ids.length == 0) {
            $.messager.alert('提示', '未选中角色!');
            return;
        }
        $.messager.confirm('确认', '确定删除ID为 ' + ids + ' 的角色吗？', function (r) {
            if (r) {
                var params = {"ids": ids, "userId": userId};
                $.post("/user/role/delete_batch", params, function (data) {
                    if (data.status == 200) {
                        $.messager.alert('提示', '移除角色成功!', undefined, function () {
                            $("#dg").datagrid("reload");
                        });
                    }
                });
            }
        });
    }


    var userId;

    function saverole() {
        var roleId = $('#cc').combobox('getValue');
        var params = {"temp": roleId + 'abc' + userId};
        $.post("/user/role/", params, function (data) {
            if (data.status == 200) {
                $.messager.alert('提示', '添加角色成功!', undefined, function () {
                    $("#dg").datagrid("reload");
                });
            }
        });
    }

    function upDialog(row) {
        $('#cc').combobox({
            url: '/role/Data',
            method: 'get',
            valueField: 'roleId',
            textField: 'role'
        });
        userId = row.userId;
        $('#dg').datagrid({
            url: "/user/role/" + row.userId,
            pageSize: 10,
            method: 'get',
            columns: [[
                {field: 'ck', checkbox: true},
                {field: 'roleId', title: '角色ID', width: 100},
                {field: 'role', title: '角色', width: 100},
                {field: 'description', title: '角色描述', width: 100, align: 'right'}
            ]]
        });
    }

    function formatRoles(value, row, index) {
        return "<a href=javascript:openRoles(" + index + ")>" + "查看角色" + "</a>";
    }

    function openRoles(index) {
        var row = onUserClickRow(index);

        $("#rolesDialog").dialog({
            onOpen: function () {
                upDialog(row);
            },
            onBeforeClose: function (event, ui) {

            }
        }).dialog("open");
    };



    //根据index拿到该行
    function onUserClickRow(index) {
        var rows = $('#userList').datagrid('getRows');
        return rows[index];
    }

    function getUserSelectionsIds() {
        var userList = $("#userList");
        var sels = userList.datagrid("getSelections");
        var ids = [];
        for (var i in sels) {
            ids.push(sels[i].userId);
        }
        ids = ids.join(",");
        return ids;
    }

    function user_add() {
        $("#userAddWindow").window("open");
    }


    function user_delete() {
        var ids = getUserSelectionsIds();
        if (ids.length == 0) {
            $.messager.alert('提示', '未选中角色!');
            return;
        }
        $.messager.confirm('确认', '确定删除ID为 ' + ids + ' 的角色吗？', function (r) {
            if (r) {
                var params = {"ids": ids};
                $.post("/user/delete_batch", params, function (data) {
                    if (data.status == 200) {
                        $.messager.alert('提示', '删除角色成功!', undefined, function () {
                            $("#userList").datagrid("reload");
                        });
                    }
                });
            }
        });
    }

    function user_reload() {
        $("#userList").datagrid("reload");
    }
</script>
</body>
</html>
